# cd/helm/helmv2-dynamic.yml
# Detect changed Helm charts and trigger parallel deployments.

variables:
  IMAGE_REGISTRY: "registry.dev.sbiepay.sbi:8443"
  GIT_STRATEGY: clone
  GIT_DEPTH: 50

.git_gitimage:
  image:
    name: ${IMAGE_REGISTRY}/library/rhelgit:latest
    entrypoint: [""]

stages:
  - validate
  - deploy

# ---------------------------------------------------
# 1) Detect changed Helm charts
# ---------------------------------------------------
detect_changed_charts:
  stage: validate
  extends:
    - .git_gitimage
  script:
    - |
      set -eo pipefail

      git config --global http.sslVerify false
      git config --global --add safe.directory '*'
      git config --global user.name "ci"
      git config --global user.email "ci.cedge@sbi.co.in"

      # Determine changed files
      if [ -n "$CI_COMMIT_BEFORE_SHA" ] && \
         [ "$CI_COMMIT_BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
        CHANGED_FILES=$(git diff --name-only "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA")
      else
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || git ls-files)
      fi

      echo "$CHANGED_FILES" > changed_files.txt

      CHART_LINES=$(grep -E '^(dev|sit|uat|int|perf|pre-prod|pre-prod-dc|prod-dr|prod-dc)/charts/[^/]+' changed_files.txt \
        | sed -E 's|(.*)/charts/([^/]+)/.*|\1/\2|' \
        | sort -u || true)

      if [ -z "$CHART_LINES" ]; then
        echo "NO_CHARTS_CHANGED=1" > changed_charts.env
      else
        echo "$CHART_LINES" > changed_charts.txt
        echo "NO_CHARTS_CHANGED=0" > changed_charts.env
      fi
  artifacts:
    reports:
      dotenv: changed_charts.env
    paths:
      - changed_charts.txt
    expire_in: 1h
  rules:
    - changes:
        - "**/charts/**/*"
      when: on_success
    - when: manual

# ---------------------------------------------------
# 2) Generate child pipeline YAML
# ---------------------------------------------------
generate_dynamic_pipeline:
  stage: validate
  image:
    name: ${IMAGE_REGISTRY}/ubi9/ochelm:03122024
    entrypoint: [""]
  needs:
    - detect_changed_charts
  script:
    - |
      set -eo pipefail

      . changed_charts.env

      # Case: No changes → create minimal valid child pipeline
      if [ "$NO_CHARTS_CHANGED" = "1" ] || [ ! -s changed_charts.txt ]; then
        printf "stages:\n  - deploy\n\nnoop:\n  stage: deploy\n  script:\n    - echo 'No chart changes detected'\n" \
          > dynamic-child.yml
        exit 0
      fi

      # Case: Changes exist → build matrix-based child pipeline
      printf "stages:\n  - deploy\n\n" > dynamic-child.yml

      while read -r line; do
        env=$(echo "$line" | cut -d'/' -f1)
        svc=$(echo "$line" | cut -d'/' -f2)

        printf "%s:\n" "deploy__${env}__${svc}" >> dynamic-child.yml
        printf "  stage: deploy\n" >> dynamic-child.yml
        printf "  trigger:\n" >> dynamic-child.yml
        printf "    include:\n" >> dynamic-child.yml
        printf "      - project: 'epay/devops/ci-templates'\n" >> dynamic-child.yml
        printf "        ref: main\n" >> dynamic-child.yml
        printf "        file: 'cd/helm/helmv2.yml'\n" >> dynamic-child.yml
        printf "    strategy: depend\n" >> dynamic-child.yml
        printf "  variables:\n" >> dynamic-child.yml
        printf "    ENV: \"%s\"\n" "$env" >> dynamic-child.yml
        printf "    SERVICE_NAME: \"%s\"\n\n" "$svc" >> dynamic-child.yml
      done < changed_charts.txt

      echo "Generated dynamic-child.yml:"
      cat dynamic-child.yml
  artifacts:
    paths:
      - dynamic-child.yml
    expire_in: 1h

# ---------------------------------------------------
# 3) Trigger child pipeline with all deployments
# ---------------------------------------------------
trigger_deployments:
  stage: deploy
  trigger:
    include:
      - artifact: dynamic-child.yml
        job: generate_dynamic_pipeline
    strategy: depend
  needs:
    - generate_dynamic_pipeline
  rules:
    - when: on_success

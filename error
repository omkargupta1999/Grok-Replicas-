Running with gitlab-runner 17.8.0 (e4f782b3)
  on DC-Gitlab-Runner rMTQxLq3, system ID: s_948d0ccb739a
Resolving secrets
Preparing the "docker" executor
00:34
Using Docker executor with image registry.dev.sbiepay.sbi:8443/ubi9/ochelm:03122024 ...
Using helper image:  registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest  (overridden, default would be  registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-v17.8.0 )
Pulling docker image registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest ...
Using docker image sha256:c95744588b6d7e170a6866854932de40eaf1b5ed229ed818cba6a87a1f885773 for registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest with digest registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper@sha256:ebbf1c21e4272ae1f8c18b034d390809c836c2fc68c0f0f6d3a5aff9760aabf5 ...
Using helper image:  registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest  (overridden, default would be  registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-v17.8.0 )
Using docker image sha256:c95744588b6d7e170a6866854932de40eaf1b5ed229ed818cba6a87a1f885773 for registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest with digest registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper@sha256:ebbf1c21e4272ae1f8c18b034d390809c836c2fc68c0f0f6d3a5aff9760aabf5 ...
Pulling docker image registry.dev.sbiepay.sbi:8443/ubi9/ochelm:03122024 ...
Using docker image sha256:e35c3559b44abd0dfdbb0d2452de990630985a9f95782c3f92357d62e1f6db71 for registry.dev.sbiepay.sbi:8443/ubi9/ochelm:03122024 with digest registry.dev.sbiepay.sbi:8443/ubi9/ochelm@sha256:f3dea1ca55cf5f37fb762cce33f16f409e63c9ad14aa203c83963ff73244c54c ...
Preparing environment
00:09
Using helper image:  registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest  (overridden, default would be  registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-v17.8.0 )
Using docker image sha256:c95744588b6d7e170a6866854932de40eaf1b5ed229ed818cba6a87a1f885773 for registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest with digest registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper@sha256:ebbf1c21e4272ae1f8c18b034d390809c836c2fc68c0f0f6d3a5aff9760aabf5 ...
Running on runner-rmtqxlq3-project-23-concurrent-2 via Gitlab-DC-Runr...
Getting source from Git repository
00:17
$ git config --global http.proxy $HTTP_PROXY; git config --global https.proxy $HTTPS_PROXY; git config --global no.proxy $NO_PROXY
Fetching changes...
Initialized empty Git repository in /tmp/builds/epay/devops/deployment/.git/
Created fresh repository.
Checking out fffda140 as detached HEAD (ref is feature/drill_scale_up_27)...
Skipping Git submodules setup
Executing "step_script" stage of the job script
00:13
Using docker image sha256:e35c3559b44abd0dfdbb0d2452de990630985a9f95782c3f92357d62e1f6db71 for registry.dev.sbiepay.sbi:8443/ubi9/ochelm:03122024 with digest registry.dev.sbiepay.sbi:8443/ubi9/ochelm@sha256:f3dea1ca55cf5f37fb762cce33f16f409e63c9ad14aa203c83963ff73244c54c ...
$ set -eo pipefail # collapsed multi-line command
Using namespace: pre-prod-transaction
PREPROD_TOKEN
Logging into OpenShift cluster...
WARNING: Using insecure TLS client config. Setting this option is not supported!
Logged into "https://api.preprod.epay.sbi:6443" as "system:serviceaccount:default:cicd-sa" using the token provided.
You have access to 142 projects, the list has been suppressed. You can list all projects with 'oc projects'
Using project "default".
Welcome! See 'oc help' to get started.
Successfully switched to namespace pre-prod-transaction
$ set -eo pipefail # collapsed multi-line command
Deploying "txn" to pre-prod-transaction...
Chart path: /tmp/builds/epay/devops/deployment/pre-prod/charts/epay_transaction_service
Executing: helm upgrade --install "txn" /tmp/builds/epay/devops/deployment/pre-prod/charts/epay_transaction_service   --namespace pre-prod-transaction   --history-max 10   --timeout 15m
Release "txn" has been upgraded. Happy Helming!
NAME: txn
LAST DEPLOYED: Thu Nov 27 12:06:48 2025
NAMESPACE: pre-prod-transaction
STATUS: deployed
REVISION: 13
Cleaning up project directory and file based variables
00:02
Job succeeded


















==================
Running with gitlab-runner 17.8.0 (e4f782b3)
  on DC-Gitlab-Runner rMTQxLq3, system ID: s_948d0ccb739a
Resolving secrets
Preparing the "docker" executor
00:05
Using Docker executor with image registry.dev.sbiepay.sbi:8443/library/rhelgit:latest ...
Using helper image:  registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest  (overridden, default would be  registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-v17.8.0 )
Pulling docker image registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest ...
Using docker image sha256:c95744588b6d7e170a6866854932de40eaf1b5ed229ed818cba6a87a1f885773 for registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest with digest registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper@sha256:ebbf1c21e4272ae1f8c18b034d390809c836c2fc68c0f0f6d3a5aff9760aabf5 ...
Using helper image:  registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest  (overridden, default would be  registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-v17.8.0 )
Using docker image sha256:c95744588b6d7e170a6866854932de40eaf1b5ed229ed818cba6a87a1f885773 for registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest with digest registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper@sha256:ebbf1c21e4272ae1f8c18b034d390809c836c2fc68c0f0f6d3a5aff9760aabf5 ...
Pulling docker image registry.dev.sbiepay.sbi:8443/library/rhelgit:latest ...
Using docker image sha256:cc9b278413b4f7940e4ec53a72ef8389e1f78fe99aeb20c8af62f14e706074d4 for registry.dev.sbiepay.sbi:8443/library/rhelgit:latest with digest registry.dev.sbiepay.sbi:8443/library/rhelgit@sha256:8576ae23d4f1ae2cc0e30d6c1b401fee3a2386faab50c58e97b726c3dc028d09 ...
Preparing environment
00:02
Using helper image:  registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest  (overridden, default would be  registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-v17.8.0 )
Using docker image sha256:c95744588b6d7e170a6866854932de40eaf1b5ed229ed818cba6a87a1f885773 for registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper:latest with digest registry.dev.sbiepay.sbi:8443/library/gitlab-runner-helper@sha256:ebbf1c21e4272ae1f8c18b034d390809c836c2fc68c0f0f6d3a5aff9760aabf5 ...
Running on runner-rmtqxlq3-project-23-concurrent-0 via Gitlab-DC-Runr...
Getting source from Git repository
00:10
$ git config --global http.proxy $HTTP_PROXY; git config --global https.proxy $HTTPS_PROXY; git config --global no.proxy $NO_PROXY
Fetching changes...
Initialized empty Git repository in /tmp/builds/epay/devops/deployment/.git/
Created fresh repository.
Checking out fa4c1645 as detached HEAD (ref is main)...
Skipping Git submodules setup
Executing "step_script" stage of the job script
00:03
Using docker image sha256:cc9b278413b4f7940e4ec53a72ef8389e1f78fe99aeb20c8af62f14e706074d4 for registry.dev.sbiepay.sbi:8443/library/rhelgit:latest with digest registry.dev.sbiepay.sbi:8443/library/rhelgit@sha256:8576ae23d4f1ae2cc0e30d6c1b401fee3a2386faab50c58e97b726c3dc028d09 ...
$ set -eo pipefail # collapsed multi-line command
Repository root: /tmp/builds/epay/devops/deployment
Debug: GitLab CI Variables:
CI_COMMIT_SHA: fa4c16456dc8dde647386d5e1801926bdd028b0b
CI_COMMIT_BEFORE_SHA: 0000000000000000000000000000000000000000
CI_COMMIT_REF_NAME: main
CI_COMMIT_CHANGED_FILES: 
Debug: CI_COMMIT_CHANGED_FILES is empty, trying to get changed files manually...
fatal: bad object 0000000000000000000000000000000000000000
Running after_script
00:02
Running after script...
$ rm -f /tmp/services_config.yml
Uploading artifacts for failed job
00:03
Uploading artifacts...
WARNING: build.env: no matching files              
ERROR: No files to upload                          
Cleaning up project directory and file based variables
00:02
ERROR: Job failed: exit code 1





































# Try to get changed files manually if CI_COMMIT_CHANGED_FILES is empty
        if [ -z "$CI_COMMIT_CHANGED_FILES" ]; then
          echo "Debug: CI_COMMIT_CHANGED_FILES is empty, trying to get changed files manually..."

          # Normal case: both SHAs present and BEFORE_SHA is not the all-zero sentinel
          if [ -n "$CI_COMMIT_SHA" ] && [ -n "$CI_COMMIT_BEFORE_SHA" ] && \
             [ "$CI_COMMIT_BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
            CI_COMMIT_CHANGED_FILES=$(git diff --name-only "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA" || true)
            echo "Debug: Manually detected changed files between $CI_COMMIT_BEFORE_SHA and $CI_COMMIT_SHA:"
            echo "$CI_COMMIT_CHANGED_FILES"
          else
            # Fallback for first commit / missing BEFORE_SHA / all-zero BEFORE_SHA
            echo "Debug: BEFORE_SHA is empty or all zeros, using git show on current commit"
            CI_COMMIT_CHANGED_FILES=$(git show --pretty="" --name-only "$CI_COMMIT_SHA" 2>/dev/null || true)
            echo "Debug: Fallback detected files:"
            echo "$CI_COMMIT_CHANGED_FILES"
          fi
        fi





=================================================
# cd/helm/helmv2-dynamic.yml
# Detect changed Helm charts and trigger parallel deployments (child pipelines)

variables:
  IMAGE_REGISTRY: "registry.dev.sbiepay.sbi:8443"
  GIT_STRATEGY: clone
  GIT_DEPTH: 50

.git_gitimage:
  image:
    name: ${IMAGE_REGISTRY}/library/rhelgit:latest
    entrypoint: [""]

# IMPORTANT: MUST MATCH ROOT .gitlab-ci.yml STAGES
stages:
  - commit
  - validate
  - deploy
  - verify

# ---------------------------------------------------
# 1) Detect changed Helm charts
# ---------------------------------------------------
detect_changed_charts:
  stage: validate
  extends:
    - .git_gitimage
  script:
    - |
      set -eo pipefail

      git config --global http.sslVerify false
      git config --global --add safe.directory '*'
      git config --global user.name "ci"
      git config --global user.email "ci.cedge@sbi.co.in"

      # Determine changed files
      if [ -n "$CI_COMMIT_BEFORE_SHA" ] && \
         [ "$CI_COMMIT_BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
        CHANGED_FILES=$(git diff --name-only "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA")
      else
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || git ls-files)
      fi

      echo "$CHANGED_FILES" > changed_files.txt

      CHART_LINES=$(grep -E '^(dev|sit|uat|int|perf|pre-prod|pre-prod-dc|prod-dr|prod-dc)/charts/[^/]+' changed_files.txt \
        | sed -E 's|(.*)/charts/([^/]+)/.*|\1/\2|' \
        | sort -u || true)

      if [ -z "$CHART_LINES" ]; then
        echo "NO_CHARTS_CHANGED=1" > changed_charts.env
      else
        echo "$CHART_LINES" > changed_charts.txt
        echo "NO_CHARTS_CHANGED=0" > changed_charts.env
      fi

  artifacts:
    reports:
      dotenv: changed_charts.env
    paths:
      - changed_charts.txt
    expire_in: 1h

  rules:
    - changes:
        - "**/charts/**/*"
      when: on_success
    - when: manual

# ---------------------------------------------------
# 2) Generate dynamic child pipeline config
# ---------------------------------------------------
generate_dynamic_pipeline:
  stage: validate
  image:
    name: ${IMAGE_REGISTRY}/ubi9/ochelm:03122024
    entrypoint: [""]
  needs:
    - job: detect_changed_charts
      artifacts: true
  script:
    - |
      set -eo pipefail

      . changed_charts.env 2>/dev/null || true

      # ðŸ“Œ Case: No charts changed â†’ child pipeline must still contain 1 job
      if [ "$NO_CHARTS_CHANGED" = "1" ] || [ ! -s changed_charts.txt ]; then
        printf "stages:\n  - deploy\n\nnoop:\n  stage: deploy\n  script:\n    - echo 'No chart changes detected'\n" \
          > dynamic-child.yml
        exit 0
      fi

      # ðŸ“Œ Case: Changes detected
      printf "stages:\n  - deploy\n\n" > dynamic-child.yml

      while read -r line; do
        [ -z "$line" ] && continue

        env=$(echo "$line" | cut -d'/' -f1)
        svc=$(echo "$line" | cut -d'/' -f2)
        job_name="deploy__${env}__${svc}"

        {
          echo "${job_name}:"
          echo "  stage: deploy"
          echo "  trigger:"
          echo "    include:"
          echo "      - project: 'epay/devops/ci-templates'"
          echo "        ref: main"
          echo "        file: 'cd/helm/helmv2.yml'"
          echo "    strategy: depend"
          echo "  variables:"
          echo "    ENV: \"${env}\""
          echo "    SERVICE_NAME: \"${svc}\""
          echo ""
        } >> dynamic-child.yml
      done < changed_charts.txt

      echo "Generated dynamic-child.yml:"
      cat dynamic-child.yml

  artifacts:
    paths:
      - dynamic-child.yml
    expire_in: 1h

  rules:
    - when: on_success

# ---------------------------------------------------
# 3) Trigger all deployments via child pipeline
# ---------------------------------------------------
trigger_deployments:
  stage: deploy
  trigger:
    include:
      - artifact: dynamic-child.yml
        job: generate_dynamic_pipeline
    strategy: depend
  needs:
    - job: generate_dynamic_pipeline
      artifacts: true
  rules:
    - when: on_success


##########################################################


# cd/helm/helmv2-dynamic.yml
# Detect changed Helm charts and trigger parallel deployments (child pipelines)

variables:
  IMAGE_REGISTRY: "registry.dev.sbiepay.sbi:8443"
  GIT_STRATEGY: clone
  GIT_DEPTH: 50

.git_gitimage:
  image:
    name: ${IMAGE_REGISTRY}/library/rhelgit:latest
    entrypoint: [""]

# IMPORTANT: MUST MATCH ROOT .gitlab-ci.yml STAGES
stages:
  - commit
  - validate
  - deploy
  - verify

# ---------------------------------------------------
# 1) Detect changed Helm charts
# ---------------------------------------------------
detect_changed_charts:
  stage: validate
  extends:
    - .git_gitimage
  script:
    - |
      set -eo pipefail

      git config --global http.sslVerify false
      git config --global --add safe.directory '*'
      git config --global user.name "ci"
      git config --global user.email "ci.cedge@sbi.co.in"

      # Determine changed files
      if [ -n "$CI_COMMIT_BEFORE_SHA" ] && \
         [ "$CI_COMMIT_BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
        CHANGED_FILES=$(git diff --name-only "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA")
      else
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || git ls-files)
      fi

      echo "$CHANGED_FILES" > changed_files.txt

      CHART_LINES=$(grep -E '^(dev|sit|uat|int|perf|pre-prod|pre-prod-dc|prod-dr|prod-dc)/charts/[^/]+' changed_files.txt \
        | sed -E 's|(.*)/charts/([^/]+)/.*|\1/\2|' \
        | sort -u || true)

      if [ -z "$CHART_LINES" ]; then
        echo "NO_CHARTS_CHANGED=1" > changed_charts.env
      else
        echo "$CHART_LINES" > changed_charts.txt
        echo "NO_CHARTS_CHANGED=0" > changed_charts.env
      fi

  artifacts:
    reports:
      dotenv: changed_charts.env
    paths:
      - changed_charts.txt
    expire_in: 1h

  rules:
    - changes:
        - "**/charts/**/*"
      when: on_success
    - when: manual

# ---------------------------------------------------
# 2) Generate dynamic child pipeline config
# ---------------------------------------------------
generate_dynamic_pipeline:
  stage: validate
  image:
    name: ${IMAGE_REGISTRY}/ubi9/ochelm:03122024
    entrypoint: [""]
  needs:
    - job: detect_changed_charts
      artifacts: true
  script:
    - |
      set -eo pipefail

      . changed_charts.env 2>/dev/null || true

      # ðŸ“Œ Case: No charts changed â†’ child pipeline must still contain 1 job
      if [ "$NO_CHARTS_CHANGED" = "1" ] || [ ! -s changed_charts.txt ]; then
        printf "stages:\n  - deploy\n\nnoop:\n  stage: deploy\n  script:\n    - echo 'No chart changes detected'\n" \
          > dynamic-child.yml
        exit 0
      fi

      # ðŸ“Œ Case: Changes detected
      printf "stages:\n  - deploy\n\n" > dynamic-child.yml

      while read -r line; do
        [ -z "$line" ] && continue

        env=$(echo "$line" | cut -d'/' -f1)
        svc=$(echo "$line" | cut -d'/' -f2)
        job_name="deploy__${env}__${svc}"

        {
          echo "${job_name}:"
          echo "  stage: deploy"
          echo "  trigger:"
          echo "    include:"
          echo "      - project: 'epay/devops/ci-templates'"
          echo "        ref: main"
          echo "        file: 'cd/helm/helmv2.yml'"
          echo "    strategy: depend"
          echo "  variables:"
          echo "    ENV: \"${env}\""
          echo "    SERVICE_NAME: \"${svc}\""
          echo ""
        } >> dynamic-child.yml
      done < changed_charts.txt

      echo "Generated dynamic-child.yml:"
      cat dynamic-child.yml

  artifacts:
    paths:
      - dynamic-child.yml
    expire_in: 1h

  rules:
    - when: on_success

# ---------------------------------------------------
# 3) Trigger all deployments via child pipeline
# ---------------------------------------------------
trigger_deployments:
  stage: deploy
  trigger:
    include:
      - artifact: dynamic-child.yml
        job: generate_dynamic_pipeline
    strategy: depend
  needs:
    - job: generate_dynamic_pipeline
      artifacts: true
  rules:
    - when: on_success







##########################################################


# cd/helm/helmv2-dynamic.yml
# Detect changed Helm charts OR pipeline-triggered services, and trigger
# parallel deployments via cd/helm/helmv2.yml

variables:
  IMAGE_REGISTRY: "registry.dev.sbiepay.sbi:8443"
  GIT_STRATEGY: clone
  GIT_DEPTH: 50

.git_gitimage:
  image:
    name: ${IMAGE_REGISTRY}/library/rhelgit:latest
    entrypoint: [""]

# MUST MATCH ROOT .gitlab-ci.yml STAGES
stages:
  - commit
  - validate
  - deploy
  - verify

# ---------------------------------------------------
# 1) Detect changed services
#    - Case A: pipeline trigger with SERVICE_NAME+ENV â†’ treat that service as changed
#    - Case B: normal commit/merge â†’ detect changed charts via git diff
# ---------------------------------------------------
detect_changed_charts:
  stage: validate
  extends:
    - .git_gitimage
  script:
    - |
      set -eo pipefail

      echo "CI_PIPELINE_SOURCE = ${CI_PIPELINE_SOURCE}"
      echo "SERVICE_NAME       = ${SERVICE_NAME:-<empty>}"
      echo "ENV                = ${ENV:-<empty>}"

      # ---------- Case A: pipeline trigger / manual with SERVICE_NAME + ENV ----------
      if [ "${CI_PIPELINE_SOURCE}" = "pipeline" ] && [ -n "${SERVICE_NAME}" ] && [ -n "${ENV}" ]; then
        echo "Detected pipeline trigger with SERVICE_NAME+ENV â†’ bypassing git diff."
        echo "${ENV}/${SERVICE_NAME}" > changed_charts.txt
        echo "NO_CHARTS_CHANGED=0" > changed_charts.env
        echo "Using changed_charts.txt:"
        cat changed_charts.txt
        exit 0
      fi

      # ---------- Case B: normal commit/merge â†’ detect changed Helm charts ----------
      git config --global http.sslVerify false
      git config --global --add safe.directory '*'
      git config --global user.name "ci"
      git config --global user.email "ci.cedge@sbi.co.in"

      if [ -n "$CI_COMMIT_BEFORE_SHA" ] && \
         [ "$CI_COMMIT_BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
        CHANGED_FILES=$(git diff --name-only "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA")
      else
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || git ls-files)
      fi

      echo "$CHANGED_FILES" > changed_files.txt

      CHART_LINES=$(grep -E '^(dev|sit|uat|int|perf|pre-prod|pre-prod-dc|prod-dr|prod-dc)/charts/[^/]+' changed_files.txt \
        | sed -E 's|(.*)/charts/([^/]+)/.*|\1/\2|' \
        | sort -u || true)

      if [ -z "$CHART_LINES" ]; then
        echo "No Helm chart directory changes detected."
        echo "NO_CHARTS_CHANGED=1" > changed_charts.env
      else
        echo "$CHART_LINES" > changed_charts.txt
        echo "NO_CHARTS_CHANGED=0" > changed_charts.env
        echo "Detected env/service pairs:"
        cat changed_charts.txt
      fi

  artifacts:
    reports:
      dotenv: changed_charts.env
    paths:
      - changed_charts.txt
    expire_in: 1h

  rules:
    # Run on app-build trigger pipelines (CI-triggered deployment)
    - if: '$CI_PIPELINE_SOURCE == "pipeline"'
      when: on_success
    # Run on normal code/helm changes
    - changes:
        - "**/charts/**/*"
      when: on_success
    # Allow manual run if wanted
    - when: manual

# ---------------------------------------------------
# 2) Generate dynamic child pipeline (matrix of services)
# ---------------------------------------------------
generate_dynamic_pipeline:
  stage: validate
  image:
    name: ${IMAGE_REGISTRY}/ubi9/ochelm:03122024
    entrypoint: [""]
  needs:
    - job: detect_changed_charts
      artifacts: true
  script:
    - |
      set -eo pipefail

      . changed_charts.env 2>/dev/null || true

      # Case: No changes â†’ child pipeline must still contain 1 job
      if [ "${NO_CHARTS_CHANGED:-1}" = "1" ] || [ ! -s changed_charts.txt ]; then
        echo "No services detected as changed â†’ creating noop child pipeline."
        printf "stages:\n  - deploy\n\nnoop:\n  stage: deploy\n  script:\n    - echo 'No services changed â€” skipping deployment'\n" \
          > dynamic-child.yml
        exit 0
      fi

      echo "Generating dynamic-child.yml from changed_charts.txt..."

      printf "stages:\n  - deploy\n\n" > dynamic-child.yml

      # Each line is env/service, e.g. dev/epay_transaction_service
      while read -r line; do
        [ -z "$line" ] && continue

        env=$(echo "$line" | cut -d'/' -f1)
        svc=$(echo "$line" | cut -d'/' -f2)
        job_name="deploy__${env}__${svc}"

        {
          echo "${job_name}:"
          echo "  stage: deploy"
          echo "  trigger:"
          echo "    include:"
          echo "      - project: 'epay/devops/ci-templates'"
          echo "        ref: main"
          echo "        file: 'cd/helm/helmv2.yml'"
          echo "    strategy: depend"
          echo "  variables:"
          echo "    ENV: \"${env}\""
          echo "    SERVICE_NAME: \"${svc}\""
          echo ""
        } >> dynamic-child.yml
      done < changed_charts.txt

      echo "Generated dynamic-child.yml:"
      cat dynamic-child.yml

  artifacts:
    paths:
      - dynamic-child.yml
    expire_in: 1h

  rules:
    - when: on_success

# ---------------------------------------------------
# 3) Trigger child pipeline with all deployments
# ---------------------------------------------------
trigger_deployments:
  stage: deploy
  trigger:
    include:
      - artifact: dynamic-child.yml
        job: generate_dynamic_pipeline
    strategy: depend
  needs:
    - job: generate_dynamic_pipeline
      artifacts: true
  rules:
    - when: on_success


######################################################




$ git config --global http.proxy $HTTP_PROXY; git config --global https.proxy $HTTPS_PROXY; git config --global no.proxy $NO_PROXY
Fetching changes...
Initialized empty Git repository in /tmp/builds/epay/devops/deployment/.git/
Created fresh repository.
Checking out e0e11a40 as detached HEAD (ref is main)...
Skipping Git submodules setup
Executing "step_script" stage of the job script
00:01
Using docker image sha256:cc9b278413b4f7940e4ec53a72ef8389e1f78fe99aeb20c8af62f14e706074d4 for registry.dev.sbiepay.sbi:8443/library/rhelgit:latest with digest registry.dev.sbiepay.sbi:8443/library/rhelgit@sha256:8576ae23d4f1ae2cc0e30d6c1b401fee3a2386faab50c58e97b726c3dc028d09 ...
$ set -eo pipefail # collapsed multi-line command
Repository root: /tmp/builds/epay/devops/deployment
Debug: GitLab CI Variables:
CI_COMMIT_SHA: e0e11a408d7c92cbc3638568cc2ae93986c5813c
CI_COMMIT_BEFORE_SHA: 0000000000000000000000000000000000000000
CI_COMMIT_REF_NAME: main
CI_COMMIT_CHANGED_FILES: 
Debug: CI_COMMIT_CHANGED_FILES is empty, trying to get changed files manually...
fatal: bad object 0000000000000000000000000000000000000000
Running after_script
00:01
Running after script...
$ rm -f /tmp/services_config.yml
Uploading artifacts for failed job
00:02
Uploading artifacts...
WARNING: build.env: no matching files              
ERROR: No files to upload                          
Cleaning up project directory and file based variables
00:01
ERROR: Job failed: exit code 1
